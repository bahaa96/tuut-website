# Order Number System Guide

## Overview

The subscription orders system uses **short, sequential numeric order numbers** for easy customer reference.

## Format

- **Type**: Integer (numeric)
- **Range**: Starts from 1, increments by 1
- **Examples**: `1`, `2`, `3`, `4`, etc.

## How It Works

### Database Sequence

A PostgreSQL sequence automatically generates unique order numbers:

```sql
CREATE SEQUENCE subscription_order_number_seq START WITH 1;
```

### Auto-Increment

When a new order is created, the database automatically assigns the next number:

```sql
order_number INTEGER UNIQUE NOT NULL DEFAULT nextval('subscription_order_number_seq')
```

### Benefits

✅ **Simple & Clean**: Starts from 1, easy to understand  
✅ **Unique**: Database sequence guarantees no duplicates  
✅ **Sequential**: Numbers increment predictably (1, 2, 3...)  
✅ **No Code Required**: Fully handled by database  
✅ **Auto-Increment**: Works like a traditional order counter

## Customization Options

### Option 1: Start from Different Number

To start from 1000 or 10000 instead:

```sql
CREATE SEQUENCE subscription_order_number_seq START WITH 1000;
-- or
CREATE SEQUENCE subscription_order_number_seq START WITH 10000;
```

### Option 2: Add Leading Zeros Display

While stored as integer, you can format for display:

```typescript
// In your frontend code
const formattedOrderNumber = orderNumber.toString().padStart(6, '0');
// 1234 becomes "001234"
```

### Option 3: Add Prefix for Display Only

Keep database as integer but display with prefix:

```typescript
// In your frontend code
const displayOrderNumber = `SUB-${orderNumber}`;
// 1234 becomes "SUB-1234"
```

### Option 4: Year-Based Sequential

Reset counter each year (requires custom logic):

```sql
-- Example: YYYYNNNNN format (2026 + 5-digit number)
-- Requires trigger/function implementation
-- 202600001, 202600002, etc.
```

## Managing the Sequence

### Check Current Value

```sql
SELECT last_value FROM subscription_order_number_seq;
```

### Reset Sequence (Careful!)

```sql
-- Reset to 1
ALTER SEQUENCE subscription_order_number_seq RESTART WITH 1;
```

### Set to Specific Value

```sql
-- Continue from 100
SELECT setval('subscription_order_number_seq', 100);
```

### Get Next Value (Without Consuming)

```sql
SELECT nextval('subscription_order_number_seq');
```

## Migration from Old Format

If you already have orders with the old `ORD-{timestamp}-{random}` format:

The migration will **drop the old column** and create a new numeric one with sequential numbers assigned based on creation order.

```sql
-- Old VARCHAR column is dropped
-- New INTEGER column is created with sequential numbers
order_number INTEGER UNIQUE NOT NULL
```

**Note**: Old order numbers will be lost. If you need to preserve them, export the data before running the migration.

## Display in UI

### Success Page Example

```typescript
// Display the order number
<p className="text-2xl font-bold text-[#111827]">
  {order.order_number}
</p>
```

### With Prefix for Branding

```typescript
<p className="text-2xl font-bold text-[#111827]">
  #{order.order_number}
</p>
// Shows: #1234
```

### Formatted with Leading Zeros

```typescript
<p className="text-2xl font-bold text-[#111827]">
  {String(order.order_number).padStart(6, '0')}
</p>
// Shows: 001234
```

## Code Examples

### Creating an Order (Auto-Generates Number)

```typescript
const { data: order } = await supabase
  .from("subscription_orders")
  .insert({
    subscription_id: "...",
    customer_whatsapp: "+1234567890",
    price: 99.99,
    currency: "USD",
    country_slug: "us",
    // order_number is auto-generated by database
  })
  .select()
  .single();

console.log(order.order_number); // e.g., 1, 2, 3...
```

### Fetching by Order Number

```typescript
const { data: order } = await supabase
  .from("subscription_orders")
  .select("*")
  .eq("order_number", 123)
  .single();
```

### Customer Support Lookup

```typescript
// Customer says: "My order number is 123"
const { data: order } = await requestFetchSubscriptionOrderByNumber({
  orderNumber: 123
});
```

## Best Practices

1. **Never Reset in Production**: Once live, don't reset the sequence
2. **Monitor Gaps**: If you delete orders, gaps are normal and OK
3. **Don't Expose Internal IDs**: Show order_number to customers, not UUID
4. **Log Sequence Changes**: Any manual sequence changes should be logged
5. **Backup Before Changes**: Always backup before modifying sequences

## Troubleshooting

### Sequence Out of Sync

If manual inserts caused issues:

```sql
-- Fix sequence to continue from highest existing number
SELECT setval('subscription_order_number_seq', 
  (SELECT MAX(order_number) FROM subscription_orders) + 1
);
```

### Duplicate Order Numbers

Should never happen, but if it does:

```sql
-- Check for duplicates
SELECT order_number, COUNT(*) 
FROM subscription_orders 
GROUP BY order_number 
HAVING COUNT(*) > 1;
```

### Want to Switch Format

Create a new migration, don't modify existing orders.

## Summary

- ✅ **Simple**: Starts from 1, easy to understand
- ✅ **Clean**: No complicated prefixes or formats
- ✅ **Automatic**: No code needed, database handles it
- ✅ **Scalable**: Supports millions of orders
- ✅ **Standard**: Traditional auto-increment approach

Order numbers increment naturally: 1, 2, 3, 4... Simple and straightforward!
